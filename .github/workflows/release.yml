name: Create Release and Build APK

on:
  push:
    tags:
      - 'v*.*.*'  # ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ tag Ù…Ø«Ù„ v3.3.7
  workflow_dispatch:
    inputs:
      version:
        description: 'Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± (Ù…Ø«Ø§Ù„: 3.3.7)'
        required: true
        type: string

jobs:
  create-release:
    name: Ø¥Ù†Ø´Ø§Ø¡ Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: $VERSION"

      - name: Ø¥Ù†Ø´Ø§Ø¡ Release Ø¹Ù„Ù‰ GitHub
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          release_name: Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ steps.get_version.outputs.version }}
          body: |
            ## ğŸ‰ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ steps.get_version.outputs.version }}
            
            ### Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ§Øª
            - ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
            
            ### Ø§Ù„ØªØ­Ù…ÙŠÙ„
            ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù APK Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„
          draft: false
          prerelease: false

  build-android:
    name: Ø¨Ù†Ø§Ø¡ APK
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Dependencies
        run: npm install

      - name: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        env:
          APP_VERSION: ${{ needs.create-release.outputs.version }}
        run: |
          echo "ğŸ“¦ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¥Ù„Ù‰: $APP_VERSION"
          npm run update-version

      - name: Build Web Assets
        run: VITE_API_URL="https://rrrr-production-f1ca.up.railway.app/api" npm run build

      - name: Initialize Android Platform
        run: npx cap add android

      - name: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø¥ØµØ¯Ø§Ø± Android
        env:
          APP_VERSION: ${{ needs.create-release.outputs.version }}
        run: npm run update-android-version

      - name: Add google-services.json (base64)
        run: |
          mkdir -p android/app
          printf "%s" "${{ secrets.GOOGLE_SERVICES_JSON_B64 }}" | base64 --decode > android/app/google-services.json
          test -s android/app/google-services.json

      - name: Install Capacitor Assets Tool
        run: npm i -D @capacitor/assets

      - name: Generate Android assets from resources
        run: npx @capacitor/assets generate --android

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build APK with Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: ØªÙˆÙ‚ÙŠØ¹ APK (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        run: |
          echo "âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ø¹Ø¯. Ø³ÙŠØªÙ… Ø±ÙØ¹ APK ØºÙŠØ± Ù…ÙˆÙ‚Ù‘Ø¹."
          # ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹

      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: android/app/build/outputs/apk/release/app-release-unsigned.apk
          asset_name: Ratelozn-v${{ needs.create-release.outputs.version }}.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Ratelozn-App-v${{ needs.create-release.outputs.version }}
          path: android/app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 30
