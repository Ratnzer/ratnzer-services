name: Unified App Build & Release

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [ "main" ]
    tags:
      - '*.*.*'
      - '*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        type: string

jobs:
  build-and-release:
    name: Build & Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        id: vars
        run: |
          # ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø­Ø¯Ø« Release Ø±Ø³Ù…ÙŠ (Ø¹Ø¨Ø± Tag Ø£Ùˆ Dispatch)
          IS_TAG_EVENT=false
          if [[ "${{ github.ref }}" == refs/tags/* ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "" ]]; then
            IS_TAG_EVENT=true
          fi
          echo "is_tag_event=$IS_TAG_EVENT" >> $GITHUB_OUTPUT
          
          # ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Ø¥Ø²Ø§Ù„Ø© Ø­Ø±Ù v Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù† ÙˆÙØ¬Ø¯
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#v}
          else
            # Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Release Ù…Ù† GitHub Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙƒÙ…Ø±Ø¬Ø¹
            LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
            if [ -n "$LATEST_RELEASE" ]; then
              VERSION=${LATEST_RELEASE#v}
            else
              VERSION=$(node -p "require('./package.json').version")
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯: $VERSION"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Dependencies
        run: npm install

      - name: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª
        env:
          APP_VERSION: ${{ steps.vars.outputs.version }}
        run: npm run update-version

      - name: Build Web Assets
        run: VITE_API_URL="https://rrrr-production-f1ca.up.railway.app/api" npm run build

      - name: Initialize Android Platform
        run: npx cap add android

      - name: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø¥ØµØ¯Ø§Ø± Android
        env:
          APP_VERSION: ${{ steps.vars.outputs.version }}
        run: npm run update-android-version

      - name: Add google-services.json (base64)
        run: |
          mkdir -p android/app
          printf "%s" "${{ secrets.GOOGLE_SERVICES_JSON_B64 }}" | base64 --decode > android/app/google-services.json
          test -s android/app/google-services.json

      - name: Install Capacitor Assets Tool
        run: npm i -D @capacitor/assets

      - name: Generate Android assets from resources
        run: npx @capacitor/assets generate --android

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build APK (Always Release)
        run: |
          cd android
          chmod +x gradlew
          echo "ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø±Ø³Ù…ÙŠØ© (Release APK)..."
          ./gradlew assembleRelease

      - name: ØªÙˆÙ‚ÙŠØ¹ APK ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Sign APK)
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: android/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Ø¥Ù†Ø´Ø§Ø¡ Release ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ù„Ù (ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Tag Ø£Ùˆ Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠ)
        if: steps.vars.outputs.is_tag_event == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.version }}
          name: Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ steps.vars.outputs.version }}
          files: ${{ steps.sign_app.outputs.signedReleaseFile }}
          body: |
            ## ğŸ‰ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ steps.vars.outputs.version }}
            ØªÙ… Ø¨Ù†Ø§Ø¡ ÙˆØªÙˆÙ‚ÙŠØ¹ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
          draft: false
          prerelease: false

      - name: Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙƒÙ€ Artifact (Ù…ØªØ§Ø­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„ØªØ­Ù…ÙŠÙ„)
        uses: actions/upload-artifact@v4
        with:
          name: Ratelozn-App-v${{ steps.vars.outputs.version }}
          path: ${{ steps.sign_app.outputs.signedReleaseFile }}
          retention-days: 14
