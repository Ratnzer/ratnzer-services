name: Unified App Build & Release

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [ "main" ]
    tags:
      - '*.*.*'
      - '*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        type: string

jobs:
  build-and-release:
    name: Build & Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        id: vars
        run: |
          IS_TAG_EVENT=false
          if [[ "${{ github.ref }}" == refs/tags/* ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "" ]]; then
            IS_TAG_EVENT=true
          fi
          echo "is_tag_event=$IS_TAG_EVENT" >> $GITHUB_OUTPUT
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#v}
          else
            LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
            if [ -n "$LATEST_RELEASE" ]; then
              VERSION=${LATEST_RELEASE#v}
            else
              VERSION=$(node -p "require('./package.json').version")
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯: $VERSION"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Build Web Assets
        env:
          VITE_API_URL: https://ratnzer-services-bb0a0cce4837.herokuapp.com/api
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
        run: npm run build

      - name: Ø¶ØºØ· Ù…Ù„ÙØ§Øª Ø§Ù„ÙˆÙŠØ¨ (Web Build)
        run: |
          zip -r web-build-v${{ steps.vars.outputs.version }}.zip dist/

      - name: Initialize Android Platform
        run: |
          rm -rf android
          npx cap add android

      - name: Overwrite Gradle Configs (Clean Fix)
        run: |
          echo "Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ù…Ù„ÙØ§Øª Gradle Ø¨Ø´ÙƒÙ„ Ù†Ø¸ÙŠÙ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚..."
          
          # 1. ØªØ­Ø¯ÙŠØ« variables.gradle
          cat > android/variables.gradle <<EOF
          ext {
              minSdkVersion = 23
              compileSdkVersion = 34
              targetSdkVersion = 34
              androidxActivityVersion = '1.8.0'
              androidxAppCompatVersion = '1.6.1'
              androidxCoordinatorLayoutVersion = '1.2.0'
              androidxCoreVersion = '1.12.0'
              androidxFragmentVersion = '1.6.2'
              coreSplashScreenVersion = '1.0.1'
              androidxWebkitVersion = '1.9.0'
              junitVersion = '4.13.2'
              androidxJunitVersion = '1.1.5'
              androidxEspressoCoreVersion = '3.5.1'
              cordovaAndroidVersion = '10.1.1'
          }
          EOF

          # 2. ØªØ­Ø¯ÙŠØ« build.gradle (Project Level)
          cat > android/build.gradle <<EOF
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.1'
                  classpath 'com.google.gms:google-services:4.4.1'
              }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOF

          # 3. ØªØ­Ø¯ÙŠØ« build.gradle (App Level)
          cat > android/app/build.gradle <<EOF
          apply plugin: 'com.android.application'
          
          android {
              namespace "com.ratnzer.app"
              compileSdkVersion 34
              defaultConfig {
                  applicationId "com.ratnzer.app"
                  minSdkVersion 23
                  targetSdkVersion 34
                  versionCode 1
                  versionName "1.0"
                  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
              }
              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
                  }
              }
          }

          repositories {
              flatDir {
                  dirs 'libs'
              }
          }

          dependencies {
              implementation fileTree(dir: 'libs', include: ['*.jar'])
              implementation "androidx.appcompat:appcompat:1.6.1"
              implementation "androidx.coordinatorlayout:coordinatorlayout:1.2.0"
              implementation "androidx.core:core:1.12.0"
              implementation "androidx.core:core-splashscreen:1.0.1"
              implementation project(':capacitor-android')
              implementation project(':capacitor-cordova-android-plugins')
              
              // Firebase
              implementation platform('com.google.firebase:firebase-bom:33.1.0')
              implementation 'com.google.firebase:firebase-analytics'
              
              testImplementation "junit:junit:4.13.2"
              androidTestImplementation "androidx.test.ext:junit:1.1.5"
              androidTestImplementation "androidx.test.espresso:espresso-core:3.5.1"
          }

          apply from: 'capacitor.build.gradle'
          apply plugin: 'com.google.gms.google-services'
          EOF

      - name: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø¥ØµØ¯Ø§Ø± Android
        env:
          APP_VERSION: ${{ steps.vars.outputs.version }}
        run: npm run update-android-version

      - name: Add google-services.json (base64)
        run: |
          mkdir -p android/app
          if [ -n "${{ secrets.GOOGLE_SERVICES_JSON_B64 }}" ]; then
            printf "%s" "${{ secrets.GOOGLE_SERVICES_JSON_B64 }}" | base64 --decode > android/app/google-services.json
          fi

      - name: Setup Facebook Authentication Config
        run: |
          STRINGS_FILE="android/app/src/main/res/values/strings.xml"
          mkdir -p android/app/src/main/res/values
          echo '<?xml version="1.0" encoding="utf-8"?>' > "$STRINGS_FILE"
          echo '<resources>' >> "$STRINGS_FILE"
          echo '    <string name="app_name">Ø®Ø¯Ù…Ø§Øª Ø±Ø§ØªÙ†Ø²Ø±</string>' >> "$STRINGS_FILE"
          echo '    <string name="title_activity_main">Ø®Ø¯Ù…Ø§Øª Ø±Ø§ØªÙ†Ø²Ø±</string>' >> "$STRINGS_FILE"
          echo '    <string name="package_name">com.ratnzer.app</string>' >> "$STRINGS_FILE"
          echo '    <string name="custom_url_scheme">com.ratnzer.app</string>' >> "$STRINGS_FILE"
          echo '    <string name="facebook_app_id">2994111874110231</string>' >> "$STRINGS_FILE"
          echo '    <string name="fb_login_protocol_scheme">fb2994111874110231</string>' >> "$STRINGS_FILE"
          echo '    <string name="facebook_client_token">c55884326412a3468d50b1952f047bbd</string>' >> "$STRINGS_FILE"
          echo '</resources>' >> "$STRINGS_FILE"

      - name: Install Capacitor Assets Tool
        run: npm i -D @capacitor/assets --legacy-peer-deps

      - name: Generate Android assets from resources
        run: npx @capacitor/assets generate --android

      - name: Sync Capacitor (Final)
        run: npx cap sync android

      - name: Build APK & AAB (Always Release)
        run: |
          cd android
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            ./gradlew assembleRelease
            ./gradlew bundleRelease
          else
            echo "Ø®Ø·Ø£: Ù…Ù„Ù gradlew Ù…ÙÙ‚ÙˆØ¯!"
            exit 1
          fi

      - name: ØªÙˆÙ‚ÙŠØ¹ Ù…Ù„Ù APK
        uses: r0adkll/sign-android-release@v1
        id: sign_apk
        with:
          releaseDirectory: android/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: ØªÙˆÙ‚ÙŠØ¹ Ù…Ù„Ù AAB
        uses: r0adkll/sign-android-release@v1
        id: sign_aab
        with:
          releaseDirectory: android/app/build/outputs/bundle/release
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: Ø¥Ù†Ø´Ø§Ø¡ Release ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        if: steps.vars.outputs.is_tag_event == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.vars.outputs.version }}
          name: Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ steps.vars.outputs.version }}
          files: |
            ${{ steps.sign_apk.outputs.signedReleaseFile }}
            ${{ steps.sign_aab.outputs.signedReleaseFile }}
            web-build-v${{ steps.vars.outputs.version }}.zip
          body: |
            ## Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ steps.vars.outputs.version }}
            ØªÙ… Ø¨Ù†Ø§Ø¡ ÙˆØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù€ Firebase Ùˆ Facebook.
          draft: false
          prerelease: false

      - name: Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙƒÙ€ Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Ratnzer-App-v${{ steps.vars.outputs.version }}
          path: |
            ${{ steps.sign_apk.outputs.signedReleaseFile }}
            ${{ steps.sign_aab.outputs.signedReleaseFile }}
            web-build-v${{ steps.vars.outputs.version }}.zip
          retention-days: 14
