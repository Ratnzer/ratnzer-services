name: Build Android App (APK)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-android:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù€ tags

      - name: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø±Ù‚Ù… Ø¥ØµØ¯Ø§Ø± Ù…Ù† GitHub Releases
        id: get_version
        run: |
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« release
          LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          
          if [ -n "$LATEST_RELEASE" ]; then
            # Ø¥Ø²Ø§Ù„Ø© Ø­Ø±Ù v Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù† ÙˆÙØ¬Ø¯
            VERSION=${LATEST_RELEASE#v}
            echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Release: $VERSION"
          else
            # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ releaseØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù…Ù† package.json
            VERSION=$(node -p "require('./package.json').version")
            echo "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ReleasesØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù…Ù† package.json: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Dependencies
        run: npm install

      - name: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        run: |
          echo "ðŸ“¦ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¥Ù„Ù‰: $APP_VERSION"
          npm run update-version

      # âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ â€” Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¯Ø§Ø®Ù„ build Ø­ØªÙ‰ Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… localhost
      - name: Build Web Assets
        run: VITE_API_URL="https://rrrr-production-f1ca.up.railway.app/api" npm run build

      # Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ© Android Ø¯Ø§Ø®Ù„ CI (Ù„Ø£Ù†Ùƒ Ù…Ø§ Ø±ÙØ¹ØªÙ‡Ø§ ÙÙŠ GitHub)
      - name: Initialize Android Platform
        run: npx cap add android

      - name: ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø¥ØµØ¯Ø§Ø± Android
        run: npm run update-android-version

      # âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù Firebase Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù…Ù† GitHub Secret (Base64)
      - name: Add google-services.json (base64)
        run: |
          mkdir -p android/app
          printf "%s" "${{ secrets.GOOGLE_SERVICES_JSON_B64 }}" | base64 --decode > android/app/google-services.json
          test -s android/app/google-services.json

      - name: Install Capacitor Assets Tool
        run: npm i -D @capacitor/assets

      - name: Generate Android assets from resources
        run: npx @capacitor/assets generate --android

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build APK with Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Ratelozn-App-Debug-v${{ steps.get_version.outputs.version }}
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 5
